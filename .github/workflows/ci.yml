name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  backend:
    name: Backend — test & vet
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      DB_CONNECT_RETRIES: "1"
      DB_RETRY_DELAY_MS: "100"
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: gofmt check
      run: |
        set -euo pipefail
        out=$(gofmt -s -l . | wc -l)
        if [ "$out" -ne 0 ]; then
          echo "Files must be gofmt'ed:" && gofmt -s -l .
          exit 1
        fi

    - name: Generate swagger docs (if missing or always regenerate)
      working-directory: ./backend
      run: |
        set -euo pipefail
        # Always regenerate docs to ensure they're up-to-date
        echo "Generating Swagger documentation..."
        go generate ./...

        # Verify docs folder and files were created
        if [ ! -d "docs" ]; then
          echo "ERROR: docs folder was not created by 'go generate'"
          exit 1
        fi

        # Verify critical files exist
        for file in docs/docs.go docs/swagger.json docs/swagger.yaml; do
          if [ ! -f "$file" ]; then
            echo "ERROR: $file was not generated"
            exit 1
          fi
          echo "✓ $file exists"
        done

        # Create additional files expected by tests and routes
        cp docs/swagger.json docs/openapi.json
        echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="refresh" content="0; url=/swagger/index.html"><title>Redirecting...</title></head><body><p>Redirecting to <a href="/swagger/index.html">Swagger UI</a>...</p></body></html>' > docs/swagger.html

        echo "✓ All documentation files generated successfully"
        ls -lh docs/

    - name: Run backend tests (with coverage)
      working-directory: ./backend
      run: |
        set -euo pipefail
        # run tests and produce coverage for the backend (excluding auto-generated docs)
        go test -coverprofile=coverage.out $(go list ./... | grep -v '/docs') -v
        go tool cover -func=coverage.out | tee coverage.txt

    - name: Enforce coverage threshold (90%)
      working-directory: ./backend
      run: |
        set -euo pipefail
        COVER=$(go tool cover -func=coverage.out | awk '/^total:/ {sub(/%/,"",$3); print $3}')
        echo "backend coverage: ${COVER}%"
        THRESHOLD=90
        # fail if coverage < THRESHOLD
        awk -v c="$COVER" -v t="$THRESHOLD" 'BEGIN{ if (c+0 < t) exit 1 }' || { echo "Coverage ${COVER}% < ${THRESHOLD}%"; exit 1; }

    - name: Upload backend coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: ./backend/coverage.out

    - name: Upload coverage to Codecov (OIDC + token fallback)
      uses: codecov/codecov-action@v5
      with:
        use_oidc: true
        token: ${{ env.CODECOV_TOKEN }}
        files: ./backend/coverage.out
        fail_ci_if_error: false

    - name: 'Note: Codecov upload method'
      if: ${{ env.CODECOV_TOKEN == '' }}
      run: |
        echo "No CODECOV_TOKEN secret provided; the job will attempt OIDC-based upload to Codecov."
        echo "If your Codecov org requires tokens for protected branches, add CODECOV_TOKEN in Settings -> Secrets -> Actions."

  frontend:
    name: Frontend — typecheck & lint
    runs-on: ubuntu-latest
    needs: backend
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install frontend deps
      working-directory: ./frontend
      run: npm ci

    - name: Typecheck
      working-directory: ./frontend
      run: npx tsc --noEmit

    - name: Lint (if configured)
      working-directory: ./frontend
      run: npm run lint --if-present || true

  docs-check:
    name: OpenAPI parity check
    runs-on: ubuntu-latest
    needs: [ backend, frontend ]
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go (for swag)
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Generate OpenAPI (swag)
      run: |
        set -euo pipefail
        TMPDIR=$(mktemp -d)
        # Generate using pinned swag version to avoid tool mismatch
        go run github.com/swaggo/swag/cmd/swag@v1.8.12 init -g backend/main.go -o "$TMPDIR" --outputTypes json
        echo "Generated swagger in temp dir:"
        ls -lh "$TMPDIR"

        # If backend/docs/swagger.json doesn't exist, generate it
        if [ ! -f "backend/docs/swagger.json" ]; then
          echo "⚠️  WARNING: backend/docs/swagger.json not found in repository"
          echo "Auto-generating docs (this should be committed to avoid this warning)"
          mkdir -p backend/docs
          cd backend && go generate ./... && cd ..
          echo "✓ Generated missing docs"
        fi

        echo "Comparing generated swagger.json with committed backend/docs/swagger.json"
        if ! diff -u backend/docs/swagger.json "$TMPDIR/swagger.json"; then
          echo ""
          echo "ERROR: generated OpenAPI differs from committed file."
          echo "Run 'cd backend && go generate ./...' and commit the result."
          exit 1
        fi
        echo "✓ OpenAPI documentation is up-to-date"

  check-release-readiness:
    name: Release readiness (quick)
    runs-on: ubuntu-latest
    needs: [ backend, frontend, docs-check ]
    steps:
    - uses: actions/checkout@v4
    - name: Quick sanity
      run: |
        echo "gofmt / tests / tsc / openapi parity passed in previous jobs"
        echo "OK"
